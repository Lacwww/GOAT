<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="placens">
	<!-- place_num 얻기 -->
	<select id="getPlaceNum" resultType="integer">
		select count(*) + 1 from place
	</select>
	
	<!-- 지역에 해당하는 장소 총 갯수 -->
	<select id="getTotal" parameterType="place" resultType="integer">
		select nvl(count(*), 0) from place
		<where>
			place_area = #{place_area}
			<if test="keyword!=null and keyword!=''">
				and place_name like '%'||#{keyword}||'%'
			</if>
		</where>
	</select>
	
	<!-- 지역에 해당하는 장소의 리스트 -->
	<select id="list" parameterType="map" resultType="place">
		select * from (select a.*,rowNum rn from( 
			select * from place
		<where>
			place_area = #{place_area}
			<if test="keyword != null and keyword !='' ">
				and place_name like '%'||#{keyword}||'%'
			</if>
		</where>
			 order by place_name)a)
				where rn between #{startRow} and #{endRow}	
	</select>
	
	<!-- 장소 모달 -->
	<select id="placeModal" parameterType="integer" resultType="place">
		select * from place where place_num = #{num}
	</select>
	
	<!-- 장소의 평점 구하기 -->
	<select id="avgScore" parameterType="integer" resultType="float">
		select nvl(avg(score), 0) from place_review where place_num = #{num}
	</select>
	
	<!-- 장소 댓글 리스트 -->
	<select id="prevList" parameterType="integer" resultType="placereview">
		select p.*, m.m_name name from place_review p, member m where p.m_num = m.m_num and place_num = #{num} order by prev_num
	</select>
	
	<!-- 북마크 목록 확인 -->
	<select id="bookMarkChk" parameterType="map" resultType="bookmark">
		select * from bookmark where m_num = #{m_num} and place_num = #{place_num}	
	</select>

	<!-- 관광지 API 정보 입력 -->
	<insert id="insertAPI" parameterType="place">
		insert into place values(#{place_num}, #{place_name}, #{place_cate}, #{place_addr}, #{place_addrd},
								#{place_photo}, #{lat}, #{lng}, sysdate, #{place_content}, '제주도', #{place_tag})
	</insert>
	
	<!-- 북마크 삭제 -->
	<delete id="deleteBM" parameterType="map">
		delete from bookmark where m_num = #{m_num} and place_num = #{place_num}
	</delete>
	
	<!-- 북마크 생성 -->
	<insert id="insertBM" parameterType="map">
		<selectKey keyProperty="book_num" order="BEFORE" resultType="integer">
			select nvl(count(*), 0) + 1 from bookmark
		</selectKey>
		insert into bookmark values(#{book_num},#{m_num},#{place_num})
	</insert>
	
	<!-- 댓글 입력 -->
	<insert id="insertPrev" parameterType="placereview">
		<selectKey keyProperty="prev_num" order="BEFORE" resultType="integer">
			select nvl(count(*), 0) + 1 from place_review
		</selectKey>
		insert into place_review values(#{prev_num},#{prev_title},#{score},#{prev_content},
											'n',sysdate,#{m_num},#{place_num})
	</insert>
	
	<!-- 댓글 삭제 -->
	<update id="deletePrev" parameterType="placereview">
		update place_review set del = 'y' where prev_num = #{prev_num} and place_num = #{place_num}
	</update>
	
	<!-- 댓글 수정 -->
	<update id="updatePrev" parameterType="placereview">
		update place_review set prev_title = #{prev_title}, prev_content = #{prev_content}, score = #{score}
					where prev_num = #{prev_num}
	</update>
</mapper>